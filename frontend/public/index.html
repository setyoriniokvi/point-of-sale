<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS System</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Poppins', system-ui, -apple-system, sans-serif; }
    .badge { padding: 4px 10px; border-radius: 9999px; font-weight: 600; font-size: 12px; }
    .card-shadow { box-shadow: 0 6px 18px rgba(49, 46, 129, 0.08); }

    /* Feature-specific bars */
    .feature-bar { display:flex; align-items:center; gap:0.75rem; }
    .feature-bar.hidden { display:none; }
    .feature-bar .progress { width: 0%; transition: width 0.25s ease; }
    .feature-bar .progress.indeterminate { animation: indeterminate 1.2s linear infinite; }
    @keyframes indeterminate {
      0% { transform: translateX(-30%); width: 30%; }
      50% { transform: translateX(20%); width: 50%; }
      100% { transform: translateX(100%); width: 70%; }
    }

    /* Top nav small polish */
    #top-nav button { transition: background-color .15s, color .15s, transform .08s; }
    #top-nav button[aria-current="page"] { font-weight: 700; }

  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900">
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-600 to-emerald-400 flex items-center justify-center text-white font-bold">POS</div>
          <div>
            <h1 class="text-2xl font-semibold text-indigo-700">POS Dashboard</h1>
            <p class="text-sm text-gray-500">Sistem Point of Sales</p>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <!-- Top-right feature navigation -->
        <div id="top-nav" class="hidden md:flex items-center gap-2">
          <button id="nav-products" class="px-3 py-1 rounded text-sm text-gray-700 hover:bg-indigo-50">Produk</button>
          <button id="nav-transactions" class="px-3 py-1 rounded text-sm text-gray-700 hover:bg-indigo-50">Transaksi</button>
          <button id="nav-dashboard" class="px-3 py-1 rounded text-sm text-gray-700 hover:bg-indigo-50">Dashboard</button>
        </div>

        <div id="user-info" class="text-sm text-gray-700 hidden">
          <span id="user-name" class="font-medium"></span>
          <button id="btn-logout" class="ml-3 text-xs text-red-600 hover:underline">Logout</button>
        </div>
        <button id="btn-login" class="px-3 py-2 text-sm font-medium rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Login</button>
      </div>
    </div>
  </header> 

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow p-6 w-full max-w-sm">
      <h3 class="text-lg font-semibold mb-3">Masuk</h3>
      <form id="form-login" class="space-y-3">
        <div>
          <label class="block text-sm">Username</label>
          <input name="username" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm">Password</label>
          <input name="password" type="password" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2" />
        </div>
        <p class="text-xs text-gray-500">Default admin: admin / 12345</p>
        <div class="flex items-center justify-between">
          <button class="px-4 py-2 rounded bg-emerald-600 text-white">Masuk</button>
          <button type="button" id="btn-close-login" class="px-3 py-2 rounded bg-slate-100">Batal</button>
        </div>
        <div id="login-error" class="text-sm text-red-600"></div>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="edit-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow p-6 w-full max-w-sm">
      <h3 class="text-lg font-semibold mb-3">Edit Produk</h3>
      <form id="form-edit-product" class="space-y-3">
        <input type="hidden" id="edit-sku" />
        <label class="block text-sm">
          <span>Nama</span>
          <input id="edit-name" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2" />
        </label>
        <label class="block text-sm">
          <span>Harga</span>
          <input id="edit-price" type="number" min="0" step="0.01" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2" />
        </label>
        <label class="block text-sm">
          <span>Stok</span>
          <input id="edit-stock" type="number" min="0" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2" />
        </label>
        <div class="flex items-center justify-between">
          <button id="edit-save" class="px-4 py-2 rounded bg-emerald-600 text-white">Simpan</button>
          <button type="button" onclick="closeEditModal()" class="px-3 py-2 rounded bg-slate-100">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow p-6 w-full max-w-sm">
      <h3 class="text-lg font-semibold mb-3">Konfirmasi Hapus</h3>
      <input type="hidden" id="delete-sku" />
      <p class="text-sm text-gray-700">Apakah Anda yakin ingin menghapus produk ini?</p>
      <div class="flex items-center justify-end gap-3 mt-4">
        <button id="btn-confirm-delete" class="px-4 py-2 rounded bg-red-600 text-white">Hapus</button>
        <button type="button" onclick="closeDeleteModal()" class="px-3 py-2 rounded bg-slate-100">Batal</button>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <section class="bg-gradient-to-r from-indigo-50 to-emerald-50 rounded-lg p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold text-indigo-900">Kelola Produk & Transaksi</h2>
          <p class="text-sm text-gray-600 mt-1">Tambah produk, proses transaksi, dan dapatkan rekomendasi restock — cepat & rapi.</p>
        </div>
        <div class="text-sm text-gray-500">
          <span class="font-medium text-indigo-700">Status:</span> <span id="status-badge" class="badge bg-indigo-100 text-indigo-700">Connected</span>
        </div>
      </div>
    </section>
    <!-- Produk -->
    <div id="page-products">
    <section class="bg-white rounded-lg shadow p-6 space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold">Manajemen Produk</h2>
          <p class="text-sm text-gray-600">Tambah produk dan lihat stok.</p>
        </div>
        <button id="btn-refresh-products" class="px-3 py-2 text-sm font-medium rounded bg-slate-100 hover:bg-slate-200">
          Muat ulang
        </button>
      </div>
      <div id="product-bar" class="feature-bar hidden items-center gap-3 mt-3">
        <div class="w-full bg-gray-200 h-2 rounded overflow-hidden">
          <div class="progress bg-indigo-600 h-2" style="width:0%"></div>
        </div>
        <div id="product-bar-text" class="text-xs text-gray-600">Siap</div>
      </div>

      <form id="form-add-product" class="grid md:grid-cols-4 gap-3 items-end">
        <label class="block">
          <span class="text-sm font-medium text-gray-700">Nama</span>
          <input name="name" required placeholder="Contoh: Kopi Susu" class="mt-1 w-full rounded border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-emerald-500" />
        </label>
        <label class="block">
          <span class="text-sm font-medium text-gray-700">Harga</span>
          <input name="price" type="number" min="0" step="0.01" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-emerald-500" />
        </label>
        <label class="block">
          <span class="text-sm font-medium text-gray-700">Stok</span>
          <input name="stock" type="number" min="0" required class="mt-1 w-full rounded border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-emerald-500" />
        </label>
        <button id="btn-add-product" type="submit" class="h-[42px] rounded bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition" data-loading="false">
          Tambah Produk
        </button>
      </form>
      <div id="product-success" class="text-sm text-emerald-600 mt-2"></div>

      <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-4 mt-4"></div>
      <div id="product-error" class="text-sm text-red-600"></div> 
    </section>
    </div>

    <!-- Transaksi -->
    <div id="page-transactions" class="hidden">
    <section class="bg-white rounded-lg shadow p-6 space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold">Transaksi</h2>
          <p class="text-sm text-gray-600">Tambah item by SKU, hitung total via Transaction Service.</p>
        </div>
        <div class="text-sm text-gray-500" id="cart-count"></div>
      </div>
      <div id="transaction-bar" class="feature-bar hidden items-center gap-3 mt-3">
        <div class="w-full bg-gray-200 h-2 rounded overflow-hidden">
          <div class="progress bg-indigo-600 h-2" style="width:0%"></div>
        </div>
        <div id="transaction-bar-text" class="text-xs text-gray-600">Siap</div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 items-end">
        <label class="block md:col-span-2">
          <span class="text-sm font-medium text-gray-700">SKU Produk</span>
          <input id="input-sku" class="mt-1 w-full rounded border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500" list="sku-list" placeholder="Masukkan atau pilih SKU" />
          <datalist id="sku-list"></datalist>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-gray-700">Jumlah</span>
          <input id="input-qty" type="number" min="1" value="1" class="mt-1 w-full rounded border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500" />
        </label>
      </div>
      <div class="flex gap-3">
        <button id="btn-add-item" class="rounded bg-indigo-600 text-white px-4 py-2 font-medium hover:bg-indigo-700 transition">Tambah Item</button>
        <button id="btn-calc" class="rounded bg-emerald-600 text-white px-4 py-2 font-medium hover:bg-emerald-700 transition">Hitung Total</button>
      </div>

      <div id="cart-list" class="border border-gray-200 rounded divide-y"></div>
      <div id="cart-result" class="text-sm text-gray-700"></div>
      <div id="cart-error" class="text-sm text-red-600"></div>
      <div id="cart-success" class="text-sm text-emerald-600"></div>
    </section>
    </div>

    <!-- Dashboard sederhana (low stock) -->
    <div id="page-dashboard" class="hidden">
    <section class="bg-white rounded-lg shadow p-6 space-y-3">
      <h2 class="text-xl font-semibold">Dashboard Stok Rendah</h2>
      <p class="text-sm text-gray-600">Menampilkan produk dengan stok &lt; 10 dari Product Service.</p>
      <div class="flex items-start justify-between gap-3">
        <button id="btn-refresh-lowstock" class="px-3 py-2 text-sm font-medium rounded bg-emerald-600 text-white hover:bg-emerald-700">
          Muat ulang stok
        </button>
        <p class="text-xs text-gray-500 leading-tight max-w-xs">Klik untuk otomatis menambah stok (+50) pada produk dengan stok rendah (&lt;10).</p>
      </div>
      <div id="lowstock-bar" class="feature-bar hidden items-center gap-3 mt-3">
        <div class="w-full bg-gray-200 h-2 rounded overflow-hidden">
          <div class="progress bg-emerald-600 h-2" style="width:0%"></div>
        </div>
        <div id="lowstock-bar-text" class="text-xs text-gray-600">Siap</div>
      </div>
      <div id="lowstock-list" class="space-y-2"></div>
    </section>
  </main>

    <!-- Dashboard Summary (UI) -->
    <section class="bg-white rounded-lg shadow p-6 space-y-3">
      <h2 class="text-xl font-semibold">Dashboard Ringkasan</h2>
      <p class="text-sm text-gray-600">Ringkasan penjualan dan produk terlaris.</p>
      <div class="flex items-center gap-3">
        <button id="btn-load-dashboard" class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Muat Dashboard</button>
        <div id="dashboard-summary" class="ml-4 text-sm"></div>
      </div>
      <div id="dashboard-bar" class="feature-bar hidden items-center gap-3 mt-3">
        <div class="w-full bg-gray-200 h-2 rounded overflow-hidden">
          <div class="progress bg-indigo-600 h-2" style="width:0%"></div>
        </div>
        <div id="dashboard-bar-text" class="text-xs text-gray-600">Siap</div>
      </div>
      <div id="dashboard-best-sellers" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
    </section>
    </div>

  <script>
    // Use relative paths so the frontend can be served on :3000 and nginx will proxy / to the backend gateway
    const PRODUCT_URL = '/products';
    const TRANSACTION_URL = '/calculate-total';
    const RECO_URL = '/recommendation/restock';
    const AUTH_URL = '/api/auth';

    let authToken = localStorage.getItem('authToken');
    let authUser = JSON.parse(localStorage.getItem('authUser') || 'null');

    // Small UI helpers
    const adminOnlyForm = document.getElementById('form-add-product').parentElement;

    // Feature-specific loading/status bar helpers
    function showFeatureBar(id, text = 'Memuat...') {
      const bar = document.getElementById(id);
      if (!bar) return;
      const prog = bar.querySelector('.progress');
      const textEl = document.getElementById(id + '-text');
      if (textEl) textEl.textContent = text;
      bar.classList.remove('hidden');
      if (prog) {
        prog.style.width = '30%';
        prog.classList.add('indeterminate');
      }
    }
    function hideFeatureBar(id, text) {
      const bar = document.getElementById(id);
      if (!bar) return;
      const prog = bar.querySelector('.progress');
      const textEl = document.getElementById(id + '-text');
      if (prog) {
        prog.classList.remove('indeterminate');
        prog.style.width = '100%';
      }
      setTimeout(() => {
        if (textEl && text !== undefined) textEl.textContent = text;
        if (prog) prog.style.width = '0%';
        bar.classList.add('hidden');
      }, 300);
    }

    let products = []; 
    let cart = [];

    const productGrid = document.getElementById('product-grid');
    const productError = document.getElementById('product-error');
    const skuList = document.getElementById('sku-list');
    const cartList = document.getElementById('cart-list');
    const cartError = document.getElementById('cart-error');
    const cartSuccess = document.getElementById('cart-success');
    const cartResult = document.getElementById('cart-result');
    const cartCount = document.getElementById('cart-count');
    const lowstockList = document.getElementById('lowstock-list');

    const formatCurrency = (val) =>
      new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 2 }).format(Number(val) || 0);

    async function fetchProducts() {
      productError.textContent = '';
      showFeatureBar('product-bar', 'Memuat produk...');
      try {
        const res = await fetch(PRODUCT_URL);
        if (!res.ok) throw new Error('Gagal mengambil data produk');
        products = await res.json();
        renderProducts();
        renderSkuList();
        renderLowStock();
      } catch (e) {
        productError.textContent = e.message;
        products = [];
        renderProducts();
        renderSkuList();
        renderLowStock();
      } finally {
        hideFeatureBar('product-bar', 'Siap');
      }
    }

    function renderProducts() {
      const grid = productGrid;
      if (!products || products.length === 0) {
        grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-8">Belum ada produk. Gunakan form di atas untuk menambahkan produk baru.</div>`;
        return;
      }
      const isAdmin = authUser && authUser.role === 'admin';
      grid.innerHTML = products.map((p) => `
        <div class="bg-white rounded-lg p-4 card-shadow border border-gray-100 w-full">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-indigo-500 font-semibold truncate">${p.sku || '-'}</div>
              <div class="text-base font-medium mt-1 truncate">${p.name}</div>
              <div class="text-sm text-gray-500 mt-1">Stok: <span class="font-medium">${p.stock}</span></div>
            </div>
            <div class="text-right flex-shrink-0">
              <div class="text-sm text-gray-500">${formatCurrency(p.price)}</div>
              <div class="mt-3">
                <button class="px-3 py-1 bg-indigo-50 text-indigo-700 text-sm rounded whitespace-nowrap" onclick="askRecommendation('${p.sku}', '${p.name}', ${p.stock || 0})">Rekomendasi</button>
                ${isAdmin ? `<div class="mt-2 flex gap-2 justify-end"><button class="px-3 py-1 bg-yellow-50 text-yellow-800 text-sm rounded whitespace-nowrap" onclick="openEditModal('${p.sku}')">Edit</button><button class="px-3 py-1 bg-red-50 text-red-700 text-sm rounded whitespace-nowrap" onclick="openDeleteModal('${p.sku}')">Hapus</button></div>` : ''}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Modal-based Edit Product handlers
    function openEditModal(sku) {
      const prod = products.find(p => p.sku === sku);
      if (!prod) { showToast('Produk tidak ditemukan', 'error'); return; }
      document.getElementById('edit-sku').value = prod.sku;
      document.getElementById('edit-name').value = prod.name;
      document.getElementById('edit-price').value = prod.price;
      document.getElementById('edit-stock').value = prod.stock;
      const modal = document.getElementById('edit-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeEditModal() {
      const modal = document.getElementById('edit-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('form-edit-product').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sku = document.getElementById('edit-sku').value;
      const name = document.getElementById('edit-name').value.trim();
      const price = Number(document.getElementById('edit-price').value);
      const stock = Number(document.getElementById('edit-stock').value);
      if (!name || isNaN(price) || isNaN(stock)) { showToast('Isian tidak valid', 'error'); return; }
      const btn = document.getElementById('edit-save');
      const orig = btn.textContent;
      btn.textContent = 'Menyimpan...'; btn.setAttribute('disabled', 'disabled');
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${PRODUCT_URL}/${sku}`, { method: 'PUT', headers, body: JSON.stringify({ name, price, stock }) });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.message || 'Gagal mengupdate produk');
        }
        await fetchProducts();
        showToast('Produk berhasil diupdate', 'success');
        closeEditModal();
      } catch (err) {
        showToast('Gagal update produk: ' + err.message, 'error');
      } finally {
        btn.removeAttribute('disabled'); btn.textContent = orig;
      }
    });

    // Delete confirmation modal
    function openDeleteModal(sku) {
      document.getElementById('delete-sku').value = sku;
      const modal = document.getElementById('delete-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeDeleteModal() {
      const modal = document.getElementById('delete-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    document.getElementById('btn-confirm-delete').addEventListener('click', async () => {
      const sku = document.getElementById('delete-sku').value;
      const btn = document.getElementById('btn-confirm-delete');
      const orig = btn.textContent;
      btn.textContent = 'Menghapus...'; btn.setAttribute('disabled','disabled');
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${PRODUCT_URL}/${sku}`, { method: 'DELETE', headers });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.message || 'Gagal menghapus produk');
        }
        await fetchProducts();
        showToast('Produk dihapus', 'success');
        closeDeleteModal();
      } catch (err) {
        showToast('Gagal menghapus produk: ' + err.message, 'error');
      } finally {
        btn.removeAttribute('disabled'); btn.textContent = orig;
      }
    });
    window.openEditModal = openEditModal;
    window.openDeleteModal = openDeleteModal;

    function renderSkuList() {
      skuList.innerHTML = products.map((p) => `<option value="${p.sku}">${p.name} (stok: ${p.stock})</option>`).join('');
    }

    function renderCart() {
      cartCount.textContent = cart.length ? `${cart.length} item` : '';
      cartList.innerHTML = cart.map((item) => `
        <div class="px-4 py-3 flex items-center justify-between text-sm">
          <div>
            <p class="font-medium">${item.sku}</p>
            <p class="text-gray-500">${products.find((p) => p.sku === item.sku)?.name || 'Produk'}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-gray-700">x${item.quantity}</span>
            <button class="text-red-600 hover:text-red-700 text-xs font-medium" onclick="removeCartItem('${item.sku}')">Hapus</button>
          </div>
        </div>
      `).join('') || '<div class="px-4 py-3 text-sm text-gray-500">Belum ada item.</div>';
    }

    function renderLowStock() {
      const low = products.filter((p) => Number(p.stock) < 10);
      lowstockList.innerHTML = low.length
        ? low.map((p) => `<div class="p-3 bg-red-50 border border-red-200 rounded text-sm flex justify-between"><span>${p.name}</span><span class="font-semibold">Stok: ${p.stock}</span></div>`).join('')
        : '<div class="text-sm text-green-700">Semua stok aman (>= 10).</div>';
    }

    // Dashboard summary: fetch and render summary from Dashboard Service via gateway
    async function fetchDashboardSummary() {
      showFeatureBar('dashboard-bar','Memuat ringkasan...');
      try {
        const res = await fetch('/api/dashboard/summary');
        if (!res.ok) throw new Error('Gagal memuat ringkasan dashboard');
        const data = await res.json();
        const el = document.getElementById('dashboard-summary');
        el.innerHTML = `<div class="font-medium">Pendapatan: ${formatCurrency(data.totalRevenue)} · Transaksi: ${data.totalTransactions}</div>`;
        const bestEl = document.getElementById('dashboard-best-sellers');
        if (data.bestSellers && data.bestSellers.length) {
          bestEl.innerHTML = data.bestSellers.map(b => `<div class="p-2 border rounded">${b.sku} — Terjual: ${b.quantitySold}</div>`).join('');
        } else {
          bestEl.innerHTML = '<div class="text-sm text-gray-500">Tidak ada data produk terlaris.</div>';
        }
      } catch (err) {
        showToast('Gagal memuat dashboard: ' + err.message, 'error');
      } finally {
        hideFeatureBar('dashboard-bar','Siap');
      }
    }


    // Add product (admin only)
    document.getElementById('form-add-product').addEventListener('submit', async (e) => {
      e.preventDefault();
      showFeatureBar('product-bar','Menyimpan produk...');
      productError.textContent = '';
      document.getElementById('product-success').textContent = '';
      const submitBtn = document.getElementById('btn-add-product');
      submitBtn.setAttribute('disabled', 'disabled');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Menyimpan...';
      const form = e.target;
      const payload = {
        name: form.name.value.trim(),
        price: parseFloat(form.price.value),
        stock: parseInt(form.stock.value, 10),
      };
      try {
        if (!payload.name || isNaN(payload.price) || isNaN(payload.stock)) throw new Error('Isian tidak valid');
        const headers = { 'Content-Type': 'application/json' };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

        const res = await fetch(PRODUCT_URL, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || 'Gagal menambahkan produk');
        }
        form.reset();
        await fetchProducts();
        showToast('Produk berhasil ditambahkan.', 'success');
      } catch (err) {
        productError.textContent = err.message;
      } finally {
        submitBtn.removeAttribute('disabled');
        submitBtn.textContent = originalText;
        hideFeatureBar('product-bar','Siap');
        setTimeout(() => document.getElementById('product-success').textContent = '', 4000);
      }
    });

    // Improved reload handlers with loading state and toast notifications
    async function reloadProducts(button) {
      const btn = button || document.getElementById('btn-refresh-products');
      const orig = btn.textContent;
      btn.setAttribute('disabled', 'disabled');
      btn.textContent = 'Muat ulang...';
      try {
        await fetchProducts();
        showToast('Produk berhasil dimuat ulang.', 'success');
      } catch (err) {
        showToast('Gagal memuat produk.', 'error');
      } finally {
        btn.removeAttribute('disabled');
        btn.textContent = orig;
      }
    }

    document.getElementById('btn-refresh-products').addEventListener('click', () => reloadProducts());

    document.getElementById('btn-refresh-lowstock').addEventListener('click', async () => {
      const btn = document.getElementById('btn-refresh-lowstock');
      const orig = btn.textContent;
      btn.setAttribute('disabled', 'disabled');
      btn.textContent = 'Memuat ulang stok...';
      showFeatureBar('lowstock-bar','Melakukan restock...');
      try {
        // Call restock endpoint to auto-add stock to low stock products
        const res = await fetch('/products/restock', { method: 'POST' });
        if (!res.ok) throw new Error('Gagal melakukan restock');
        
        const result = await res.json();
        
        // Refresh products to show updated stock
        await fetchProducts();
        
        if (result.updatedCount > 0) {
          showToast(`Berhasil menambah stok ${result.updatedCount} produk (+50 per produk)`, 'success');
        } else {
          showToast('Tidak ada produk dengan stok rendah (<10) yang perlu ditambah.', 'info');
        }
        
        document.getElementById('lowstock-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (err) {
        showToast('Gagal melakukan restock: ' + err.message, 'error');
      } finally {
        btn.removeAttribute('disabled');
        btn.textContent = orig;
        hideFeatureBar('lowstock-bar','Siap');
      }
    });

    document.getElementById('btn-load-dashboard').addEventListener('click', () => {
      fetchDashboardSummary();
    });

    document.getElementById('btn-add-item').addEventListener('click', () => {
      const sku = document.getElementById('input-sku').value.trim();
      const qty = Number(document.getElementById('input-qty').value);
      cartError.textContent = '';
      cartSuccess.textContent = '';
      if (!sku || qty <= 0) {
        cartError.textContent = 'Masukkan SKU dan jumlah yang valid.';
        return;
      }
      const existing = cart.find((i) => i.sku === sku);
      if (existing) {
        existing.quantity += qty;
      } else {
        cart.push({ sku, quantity: qty });
      }
      renderCart();
      showFeatureBar('transaction-bar','Item ditambahkan');
      setTimeout(() => hideFeatureBar('transaction-bar','Siap'), 800);
    });

    function removeCartItem(sku) {
      cart = cart.filter((i) => i.sku !== sku);
      renderCart();
    }
    window.removeCartItem = removeCartItem;

    document.getElementById('btn-calc').addEventListener('click', async () => {
      cartError.textContent = '';
      cartSuccess.textContent = '';
      cartResult.textContent = '';
      if (!cart.length) {
        cartError.textContent = 'Tambahkan item terlebih dahulu.';
        return;
      }
      showFeatureBar('transaction-bar','Menghitung total...');
      try {
        const res = await fetch(TRANSACTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cart }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Gagal menghitung total');
        }
        const data = await res.json();
        cartSuccess.textContent = 'Total berhasil dihitung.';
        cartResult.innerHTML = `
          <div class="mt-2 space-y-1 text-sm">
            ${(data.items || []).map((i) => `<div class="flex justify-between"><span>${i.name} x${i.quantity}</span><span>${formatCurrency(i.subtotal)}</span></div>`).join('')}
            <div class="flex justify-between font-semibold mt-2"><span>Total</span><span>${formatCurrency(data.total)}</span></div>
          </div>
        `;
      } catch (err) {
        cartError.textContent = err.message;
      } finally {
        hideFeatureBar('transaction-bar','Siap');
      }
    });

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const id = 'toast-' + Date.now();
      const color = type === 'error' ? 'bg-red-500' : 'bg-emerald-600';
      const el = document.createElement('div');
      el.id = id;
      el.className = `${color} text-white px-4 py-2 rounded shadow-md mb-2 transition transform duration-200`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 400); }, 3000);
    }

    async function askRecommendation(sku, name, stock) {
      const rowMsg = document.createElement('div');
      rowMsg.className = 'text-xs text-purple-700';
      rowMsg.textContent = 'Meminta rekomendasi...';
      productError.innerHTML = '';
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

        const res = await fetch(RECO_URL, {
          method: 'POST',
          headers,
          body: JSON.stringify({ product_name: name, current_stock: stock }),
        });
        if (!res.ok) throw new Error('Gagal mendapatkan rekomendasi');
        const data = await res.json();
        productError.innerHTML = `<span class="text-purple-700 font-medium">[${sku}]</span> ${data.recommendation}`;
        showToast(`Rekomendasi untuk ${sku}: ${data.recommendation}`, 'success');
      } catch (err) {
        productError.textContent = err.message;
      }
    }
    window.askRecommendation = askRecommendation;

    // Toast container
    const toastContainerHtml = `<div id="toast-container" class="fixed bottom-6 right-6 z-50"></div>`;
    document.body.insertAdjacentHTML('beforeend', toastContainerHtml);

    // --- Authentication UI logic ---
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const loginModal = document.getElementById('login-modal');
    const btnCloseLogin = document.getElementById('btn-close-login');
    const formLogin = document.getElementById('form-login');
    const loginError = document.getElementById('login-error');
    const userInfo = document.getElementById('user-info');
    const userNameEl = document.getElementById('user-name');

    function updateAuthUI() {
      if (authUser) {
        userNameEl.textContent = authUser.username;
        userInfo.classList.remove('hidden');
        btnLogin.classList.add('hidden');
        // show admin product form only for admin role
        if (authUser.role === 'admin') {
          adminOnlyForm.style.display = 'block';
        } else {
          adminOnlyForm.style.display = 'none';
        }
      } else {
        userInfo.classList.add('hidden');
        btnLogin.classList.remove('hidden');
        // hide admin-only form when not logged in
        adminOnlyForm.style.display = 'none';
      }
    }

    btnLogin.addEventListener('click', () => {
      loginError.textContent = '';
      loginModal.classList.remove('hidden');
      loginModal.classList.add('flex');
    });

    btnCloseLogin.addEventListener('click', () => {
      loginModal.classList.add('hidden');
      loginModal.classList.remove('flex');
    });

    btnLogout.addEventListener('click', () => {
      authToken = null;
      authUser = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('authUser');
      updateAuthUI();
    });

    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const data = new FormData(formLogin);
      const payload = { username: data.get('username'), password: data.get('password') };
      try {
        const res = await fetch(AUTH_URL + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || 'Login gagal');
        }
        const result = await res.json();
        authToken = result.token;
        authUser = result.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('authUser', JSON.stringify(authUser));
        loginModal.classList.add('hidden');
        loginModal.classList.remove('flex');
        updateAuthUI();
      } catch (err) {
        loginError.textContent = err.message;
      }
    });

    // Health check for gateway and live status badge
    async function checkHealth() {
      const badge = document.getElementById('status-badge');
      try {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 1500);
        const res = await fetch('/health', { signal: controller.signal });
        clearTimeout(id);
        if (res.ok) {
          badge.textContent = 'Connected';
          badge.className = 'badge bg-indigo-100 text-indigo-700';
        } else {
          badge.textContent = 'Degraded';
          badge.className = 'badge bg-yellow-100 text-yellow-700';
        }
      } catch (err) {
        badge.textContent = 'Offline';
        badge.className = 'badge bg-red-100 text-red-700';
      }
    }

    // Routing and page handling helpers
    function showPage(page) {
      const pages = ['products','transactions','dashboard'];
      pages.forEach(p => {
        const el = document.getElementById('page-' + p);
        if (el) el.classList.toggle('hidden', p !== page);
        const btn = document.getElementById('nav-' + p);
        if (btn) {
          btn.classList.toggle('bg-indigo-600', p === page);
          btn.classList.toggle('text-white', p === page);
          btn.classList.toggle('text-gray-700', p !== page);
          btn.setAttribute('aria-current', p === page ? 'page' : 'false');
        }
      });
      try { history.replaceState(null, '', '#' + page); } catch(e) { location.hash = page; }
      // Trigger relevant page loads only when switching to that page
      if (page === 'products') { fetchProducts(); }
      if (page === 'dashboard') { fetchDashboardSummary(); }
      // focus first input for convenience
      setTimeout(() => {
        if (page === 'products') document.querySelector('#form-add-product input[name="name"]')?.focus();
        if (page === 'transactions') document.getElementById('input-sku')?.focus();
      }, 80);
    }
    function initRouting() {
      document.getElementById('nav-products').addEventListener('click', () => showPage('products'));
      document.getElementById('nav-transactions').addEventListener('click', () => showPage('transactions'));
      document.getElementById('nav-dashboard').addEventListener('click', () => showPage('dashboard'));
      window.addEventListener('hashchange', () => {
        const h = (location.hash || '#products').replace('#','') || 'products';
        showPage(h);
      });
      const initial = (location.hash || '#products').replace('#','') || 'products';
      showPage(initial);
    }

    // Call checkHealth periodically and after product fetches
    updateAuthUI();
    fetchProducts().then(checkHealth).catch(checkHealth);
    renderCart();
    setInterval(checkHealth, 10000);
    // Initialize routing after DOM ready (and after other initial calls)
    initRouting();
  </script>
</body>
</html>